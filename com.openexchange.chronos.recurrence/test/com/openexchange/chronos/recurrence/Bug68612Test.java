/*
 * @copyright Copyright (c) OX Software GmbH, Germany <info@open-xchange.com>
 * @license AGPL-3.0
 *
 * This code is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with OX App Suite.  If not, see <https://www.gnu.org/licenses/agpl-3.0.txt>.
 *
 * Any use of the work other than as authorized under this license or copyright law is prohibited.
 *
 */

package com.openexchange.chronos.recurrence;

import static org.junit.Assert.fail;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.SortedSet;
import java.util.TimeZone;
import java.util.TreeSet;
import org.dmfs.rfc5545.DateTime;
import org.junit.Test;
import com.openexchange.chronos.Event;
import com.openexchange.chronos.RecurrenceId;
import com.openexchange.chronos.common.CalendarUtils;
import com.openexchange.chronos.common.DefaultRecurrenceId;
import com.openexchange.chronos.recurrence.service.RecurrenceIterator;
import com.openexchange.java.Strings;
import com.openexchange.java.util.TimeZones;

/**
 * {@link Bug68612Test}
 * 
 * Strange behavior of a calendar Appointments
 *
 * @author <a href="mailto:tobias.friedrich@open-xchange.com">Tobias Friedrich</a>
 * @since v7.10.4
 */
public class Bug68612Test {

    @Test
    public void testIterateEventOccurrences() {
        testIterating("|  72259 | 20190429T090000Z,20190501T090000Z                                                                                                                                                                                                                                               |               NULL | #C5D481 | NULL   | 2017-08-14 09:25:00 | Europe/Kiev | NULL             |    2 | NULL   | 1579513755079 | 2017-08-14 09:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO,WE,FR                             | 20170814T090000Z,20190503T090000Z,20190506T090000Z,20190508T090000Z,20190510T090000Z,20190513T090000Z,20190515T090000Z,20190517T090000Z,20190522T090000Z,20190527T090000Z,20190529T090000Z,20190531T090000Z,20190603T090000Z,20190605T090000Z,20190607T090000Z,20190610T090000Z,20190612T090000Z,20190614T090000Z,20190617T090000Z,20190619T090000Z,20190626T090000Z,20190628T090000Z,20190701T090000Z,20190703T090000Z,20190705T090000Z,20190717T090000Z,20190719T090000Z,20190722T090000Z,20190724T090000Z,20190726T090000Z,20190809T090000Z,20190812T090000Z,20190814T090000Z,20190816T090000Z,20190819T090000Z,20190821T090000Z,20190823T090000Z,20190826T090000Z,20190828T090000Z,20190830T090000Z,20190902T090000Z,20190904T090000Z,20190906T090000Z,20190909T090000Z,20190911T090000Z,20190913T090000Z,20190916T090000Z,20190923T090000Z,20190925T090000Z,20190927T090000Z,20190930T090000Z,20191002T090000Z,20191004T090000Z,20191007T090000Z,20191014T090000Z,20191018T090000Z,20191028T100000Z,20191030T100000Z,20191101T100000Z,20191104T100000Z,20191111T100000Z,20191113T100000Z,20191115T100000Z,20191120T100000Z,20191122T100000Z,20191125T100000Z,20191127T100000Z,20191206T100000Z,20191223T100000Z,20191225T100000Z,20191227T100000Z | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579513755079 |  72259 |");
        testIterating("|  96425 | NULL                                                                                                                                                                                                                                                                            |               NULL | #E6EFBD | NULL   | 2017-12-29 14:50:00 | Europe/Kiev | NULL             |    2 | NULL   | 1579637029137 | 2017-12-29 13:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR                        | 20190712T123000Z,20190726T123000Z,20190809T123000Z,20190823T123000Z,20190906T123000Z,20190920T123000Z,20191004T123000Z,20191101T133000Z,20191115T133000Z,20191129T133000Z,20191213T133000Z,20191227T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579637029137 |  96425 |");
        testIterating("| 216231 | 20191023T110000Z                                                                                                                                                                                                                                                                |               NULL | #C5D481 | NULL   | 2019-10-09 11:55:00 | Europe/Kiev | NULL             |    2 | NULL   | 1579089168506 | 2019-10-09 11:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE                        | 20191009T110000Z,20191120T120000Z,20191204T120000Z,20191218T120000Z,20200101T120000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579089168506 | 216231 |");
        testIterating("| 221609 | 20190701T110000Z,20190902T110000Z                                                                                                                                                                                                                                               |               NULL | #E6EFBD | NULL   | 2019-06-10 11:50:00 | Europe/Kiev | NULL             |    2 | NULL   | 1579683694532 | 2019-06-10 11:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO                                   | 20190617T110000Z,20190624T110000Z,20190722T110000Z,20190812T110000Z,20190826T110000Z,20190916T110000Z,20190923T110000Z,20190930T110000Z,20191014T110000Z,20191021T110000Z,20191028T120000Z,20191104T120000Z,20191111T120000Z,20191202T120000Z,20191209T120000Z,20191216T120000Z,20200106T120000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579683694532 | 221609 |");
        testIterating("| 247919 | 20190423T100000Z,20190430T100000Z,20190507T100000Z,20190509T100000Z,20190514T100000Z,20190516T100000Z,20190521T100000Z,20190523T100000Z,20190530T100000Z,20190702T100000Z,20190917T100000Z,20191008T100000Z,20191015T100000Z,20191119T110000Z,20191203T110000Z,20191224T110000Z |               NULL | #F7C7E0 | NULL   | 2019-04-09 10:55:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579685142515 | 2019-04-09 10:00:00 | Europe/Kiev   |      0 |      0 | FREQ=WEEKLY;BYDAY=TU,TH                                | 20190418T100000Z,20190425T100000Z,20190502T100000Z,20190528T100000Z,20190604T100000Z,20190606T100000Z,20190611T100000Z,20190613T100000Z,20190618T100000Z,20190620T100000Z,20190625T100000Z,20190627T100000Z,20190704T100000Z,20190709T100000Z,20190711T100000Z,20190716T100000Z,20190718T100000Z,20190723T100000Z,20190725T100000Z,20190813T100000Z,20190815T100000Z,20190820T100000Z,20190822T100000Z,20190827T100000Z,20190829T100000Z,20190903T100000Z,20190905T100000Z,20190910T100000Z,20190912T100000Z,20190919T100000Z,20190924T100000Z,20190926T100000Z,20191001T100000Z,20191003T100000Z,20191010T100000Z,20191029T110000Z,20191031T110000Z,20191114T110000Z,20191121T110000Z,20191126T110000Z,20191205T110000Z,20191210T110000Z,20191212T110000Z,20191217T110000Z,20191219T110000Z,20191226T110000Z,20191231T110000Z,20200107T110000Z,20200310T110000Z                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |       243 | NULL  | 1579685142515 | 247919 |");
        testIterating("| 304806 | NULL                                                                                                                                                                                                                                                                            |               NULL | #E6EFBD | NULL   | 2019-12-25 10:25:00 | Europe/Kiev | 20191225T100000Z |    2 | NULL   | 1579513751319 | 2019-12-25 10:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191225T100000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579513751319 |  72259 |");
        testIterating("| 331315 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-26 13:00:00 | Europe/Kiev | 20191225T120000Z | 1138 | NULL   | 1578928665228 | 2019-12-26 12:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191225T120000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1578928665228 | 343288 |");
        testIterating("| 331317 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-27 15:00:00 | Europe/Kiev | 20191225T133000Z | 1138 | NULL   | 1578928685928 | 2019-12-27 14:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191225T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1578928685928 | 343290 |");
        testIterating("| 334392 | NULL                                                                                                                                                                                                                                                                            |                  0 | NULL    | NULL   | 2019-12-23 11:00:00 | Europe/Kiev | 20191223T104500Z | 2954 | NULL   | 1579673859881 | 2019-12-23 10:45:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191223T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673859881 | 344889 |");
        testIterating("| 334396 | NULL                                                                                                                                                                                                                                                                            |                  0 | NULL    | NULL   | 2019-12-27 11:00:00 | Europe/Kiev | 20191227T104500Z | 2954 | NULL   | 1579673865186 | 2019-12-27 10:45:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191227T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673865186 | 344891 |");
        testIterating("| 335886 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-16 16:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1579528064748 | 2019-12-16 14:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1579528064748 | 335886 |");
        testIterating("| 336814 | NULL                                                                                                                                                                                                                                                                            |                  0 | #E6EFBD | NULL   | 2019-12-27 14:50:00 | Europe/Kiev | 20191227T133000Z |    2 | NULL   | 1579637029137 | 2019-12-27 13:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191227T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0002-00fc-c0e11e000001 |         2 | NULL  | 1579637029137 |  96425 |");
        testIterating("| 338567 | NULL                                                                                                                                                                                                                                                                            |                  1 | #F7C7E0 | NULL   | 2019-12-27 11:55:00 | Europe/Kiev | 20191227T110000Z |  243 | NULL   | 1579685142921 | 2019-12-27 11:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191227T110000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |       243 | NULL  | 1579685142921 | 342650 |");
        testIterating("| 338864 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-24 11:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577181386196 | 2019-12-24 09:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1577181386196 |   NULL |");
        testIterating("| 338967 | NULL                                                                                                                                                                                                                                                                            |                  1 | #9BC8F7 | NULL   | 2019-12-23 10:30:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577189815506 | 2019-12-23 09:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1577189815506 |   NULL |");
        testIterating("| 338968 | NULL                                                                                                                                                                                                                                                                            |                  1 | #9BC8F7 | NULL   | 2019-12-23 11:25:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577189821613 | 2019-12-23 10:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1577189821613 |   NULL |");
        testIterating("| 338980 | NULL                                                                                                                                                                                                                                                                            |                  0 | #734EAF | NULL   | 2019-12-26 11:00:00 | Europe/Kiev | NULL             | 5021 | NULL   | 1577357851490 | 2019-12-26 10:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-139d-00fc-c0e11e000001 |      5021 | NULL  | 1577357851490 |   NULL |");
        testIterating("| 339184 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-24 14:00:00 | Europe/Kiev | NULL             | 1637 | NULL   | 1577190625586 | 2019-12-24 12:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0665-00fc-c0e11e000001 |      1637 | NULL  | 1577190625586 |   NULL |");
        testIterating("| 339190 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-24 11:25:00 | Europe/Kiev | 20191224T100000Z |   88 | NULL   | 1577106471325 | 2019-12-24 11:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | 20191224T100000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0058-00fc-c0e11e000001 |        88 | NULL  | 1577106471325 | 251673 |");
        testIterating("| 339204 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-24 16:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577199655268 | 2019-12-24 15:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1577199655268 |   NULL |");
        testIterating("| 339210 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-26 09:00:00 | Europe/Kiev | NULL             |   88 | NULL   | 1577346304987 | 2019-12-26 08:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0058-00fc-c0e11e000001 |        88 | NULL  | 1577346304987 |   NULL |");
        testIterating("| 339403 | 20191113T080000Z,20191127T080000Z,20191129T080000Z,20191206T080000Z,20191225T080000Z                                                                                                                                                                                            |                  1 | #F7C7E0 | NULL   | 2019-11-08 09:20:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579637294786 | 2019-11-08 08:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO,WE,FR;UNTIL=20191230T075959Z      | 20191118T080000Z,20191120T080000Z,20191122T080000Z,20191125T080000Z,20191202T080000Z,20191204T080000Z,20191209T080000Z,20191211T080000Z,20191213T080000Z,20191216T080000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1579637294786 | 339403 |");
        testIterating("| 339405 | 20191225T100000Z                                                                                                                                                                                                                                                                |                  1 | #C5D481 | NULL   | 2019-12-13 10:25:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577440726482 | 2019-12-13 10:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO,WE,FR;UNTIL=20191230T095959Z      | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |        88 | NULL  | 1577440726482 | 339405 |");
        testIterating("| 339407 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-23 13:00:00 | Europe/Kiev | NULL             |   88 | NULL   | 1577181738725 | 2019-12-23 12:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO;UNTIL=20191230T115959Z            | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0058-00fc-c0e11e000001 |        88 | NULL  | 1577181738725 | 339407 |");
        testIterating("| 339426 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-26 15:30:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1577372444785 | 2019-12-26 14:30:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1577372444785 |   NULL |");
        testIterating("| 339634 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-25 16:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1578664461325 | 2019-12-25 15:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1578664461325 |   NULL |");
        testIterating("| 339639 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-25 13:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1578664459708 | 2019-12-25 12:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      1138 | NULL  | 1578664459708 |   NULL |");
        testIterating("| 339979 | NULL                                                                                                                                                                                                                                                                            |                  1 | NULL    | NULL   | 2019-12-27 16:00:00 | Europe/Kiev | NULL             | 1637 | NULL   | 1577947753936 | 2019-12-27 15:00:00 | Europe/Kiev   |      0 |      1 | NULL                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | PUBLIC | urn:uuid:00011c76-0000-0665-00fc-c0e11e000001 |      1637 | NULL  | 1577947753936 |   NULL |");
        testIterating("| 342645 | 20191225T110000Z                                                                                                                                                                                                                                                                |                  1 | #F7C7E0 | NULL   | 2019-11-13 11:55:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579685138391 | 2019-11-13 11:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=WE;UNTIL=20200115T105959Z            | 20191113T110000Z,20191120T110000Z,20191127T110000Z,20191204T110000Z,20191211T110000Z,20191218T110000Z,20200101T110000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1579685138391 | 342645 |");
        testIterating("| 342647 | 20200103T110000Z                                                                                                                                                                                                                                                                |                  1 | #F7C7E0 | NULL   | 2019-12-20 11:55:00 | Europe/Kiev | NULL             |  243 | NULL   | 1578656884440 | 2019-12-20 11:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;UNTIL=20200117T105959Z | 20191220T110000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1578656884440 | 342647 |");
        testIterating("| 342648 | 20191223T103000Z                                                                                                                                                                                                                                                                |                  1 | #F7C7E0 | NULL   | 2019-12-09 11:25:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579685017029 | 2019-12-09 10:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=MO;UNTIL=20200120T102959Z | 20191209T103000Z,20200106T103000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1579685017029 | 342648 |");
        testIterating("| 342649 | 20191223T093000Z                                                                                                                                                                                                                                                                |                  1 | #F7C7E0 | NULL   | 2019-12-23 10:30:00 | Europe/Kiev | NULL             |  243 | NULL   | 1578786770492 | 2019-12-23 09:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=MO;UNTIL=20200120T092959Z | 20200106T093000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1578786770492 | 342649 |");
        testIterating("| 342650 | NULL                                                                                                                                                                                                                                                                            |                  1 | #F7C7E0 | NULL   | 2019-12-13 11:55:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579685143058 | 2019-12-13 11:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;UNTIL=20200124T105959Z | 20191213T110000Z,20191227T110000Z,20200110T110000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |        88 | NULL  | 1579685143058 | 342650 |");
        testIterating("| 342896 | 20191120T143000Z,20200101T143000Z                                                                                                                                                                                                                                               |                  0 | NULL    | NULL   | 2019-09-18 13:55:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1578853945064 | 2019-09-18 13:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=3;BYDAY=WE;UNTIL=20200122T142959Z | 20191009T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1578853945064 | 342896 |");
        testIterating("| 343288 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-25 13:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1578928665228 | 2019-12-25 12:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200122T115959Z | 20191225T120000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      2927 | NULL  | 1578928665228 | 343288 |");
        testIterating("| 343290 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-25 14:30:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1578928685928 | 2019-12-25 13:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200122T132959Z | 20191225T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      2927 | NULL  | 1578928685928 | 343290 |");
        testIterating("| 343291 | 20191218T133000Z                                                                                                                                                                                                                                                                |                  1 | #C5D481 | NULL   | 2019-12-04 14:30:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1579686781886 | 2019-12-04 13:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200129T132959Z | 20191204T133000Z,20200101T133000Z,20200115T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      2927 | NULL  | 1579686781886 | 343291 |");
        testIterating("| 343292 | NULL                                                                                                                                                                                                                                                                            |                  1 | #C5D481 | NULL   | 2019-12-18 13:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1579089801973 | 2019-12-18 12:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200129T115959Z | 20191218T120000Z,20200101T120000Z,20200115T120000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      2927 | NULL  | 1579089801973 | 343292 |");
        testIterating("| 343293 | NULL                                                                                                                                                                                                                                                                            |                  1 | #F7C7E0 | NULL   | 2019-12-20 13:25:00 | Europe/Kiev | NULL             |  243 | NULL   | 1579267643290 | 2019-12-20 12:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;UNTIL=20200131T122959Z | 20191220T123000Z,20200103T123000Z,20200117T123000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-00f3-00fc-c0e11e000001 |      2927 | NULL  | 1579267643290 | 343293 |");
        testIterating("| 343294 | NULL                                                                                                                                                                                                                                                                            |                  1 | #E6EFBD | NULL   | 2019-12-20 15:00:00 | Europe/Kiev | NULL             | 1138 | NULL   | 1579268072112 | 2019-12-20 13:30:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;UNTIL=20200131T132959Z | 20191220T133000Z,20200103T133000Z,20200117T133000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-0472-00fc-c0e11e000001 |      2927 | NULL  | 1579268072112 | 343294 |");
        testIterating("| 344889 | NULL                                                                                                                                                                                                                                                                            |                  0 | NULL    | NULL   | 2019-11-18 11:00:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1579673860033 | 2019-11-18 10:45:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;BYDAY=MO;UNTIL=20200120T104459Z            | 20191125T104500Z,20191202T104500Z,20191209T104500Z,20191216T104500Z,20191223T104500Z,20191230T104500Z,20200106T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673860033 | 344889 |");
        testIterating("| 344890 | 20191225T104500Z                                                                                                                                                                                                                                                                |                  0 | NULL    | NULL   | 2019-12-11 11:00:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1579673858450 | 2019-12-11 10:45:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200122T104459Z | 20200108T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673858450 | 344890 |");
        testIterating("| 344891 | NULL                                                                                                                                                                                                                                                                            |                  0 | NULL    | NULL   | 2019-12-13 11:00:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1579673865271 | 2019-12-13 10:45:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;UNTIL=20200124T104459Z | 20191213T104500Z,20191227T104500Z,20200110T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673865271 | 344891 |");
        testIterating("| 344892 | 20200101T090000Z                                                                                                                                                                                                                                                                |                  0 | NULL    | NULL   | 2019-12-18 10:20:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1579673862370 | 2019-12-18 09:00:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=WE;UNTIL=20200129T085959Z | 20191218T090000Z,20200115T090000Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673862370 | 344892 |");
        testIterating("| 344893 | NULL                                                                                                                                                                                                                                                                            |                  0 | NULL    | NULL   | 2019-12-05 11:00:00 | Europe/Kiev | NULL             | 2954 | NULL   | 1579673856147 | 2019-12-05 10:45:00 | Europe/Kiev   |      0 |      1 | FREQ=WEEKLY;INTERVAL=2;BYDAY=TH;UNTIL=20200130T104459Z | 20191205T104500Z,20191219T104500Z,20200102T104500Z,20200116T104500Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | PUBLIC | urn:uuid:00011c76-0000-0b8a-00fc-c0e11e000001 |      2954 | NULL  | 1579673856147 | 344893 |");
    }

    private static void testIterating(String line) {
        DateTime rangeStart = DateTime.parse("20191221T220000Z");
        DateTime rangeEnd = DateTime.parse("20191228T220000Z");
        Calendar start = CalendarUtils.initCalendar(TimeZones.UTC, rangeStart.getTimestamp());
        Calendar end = CalendarUtils.initCalendar(TimeZones.UTC, rangeEnd.getTimestamp());
        try {
            Event event = parse(line);
            if (false == CalendarUtils.isSeriesMaster(event)) {
                return;
            }
            RecurrenceIterator iterator = new RecurrenceIterator(new TestRecurrenceConfig(), event, true, start, end, null, true);
            while (iterator.hasNext()) {
                iterator.next();
            }
        } catch (Exception e) {
            fail(e.getMessage() + ", for: " + line);
        }
    }

    private static Event parse(String line) throws Exception {
        String[] splitted = Strings.splitBy(line, '|', true);
        Event event = new Event();
        event.setId(splitted[1]);
        event.setDeleteExceptionDates(parseRecurrenceIds(splitted[2]));
        event.setEndDate(new DateTime(TimeZone.getTimeZone(splitted[7]), parseDate(splitted[6])));
        event.setRecurrenceId("NULL".equals(splitted[8]) ? null : parseRecurrenceIds(splitted[8]).first());
        event.setStartDate(new DateTime(TimeZone.getTimeZone(splitted[13]), parseDate(splitted[12])));
        event.setRecurrenceRule("NULL".equals(splitted[16]) ? null : splitted[16]);
        event.setChangeExceptionDates(parseRecurrenceIds(splitted[17]));
        event.setRecurrenceDates(parseRecurrenceIds(splitted[21]));
        event.setSeriesId("NULL".equals(splitted[23]) ? null : splitted[23]);
        return event;
    }

    private static SortedSet<RecurrenceId> parseRecurrenceIds(String value) {
        if (Strings.isEmpty(value) || "NULL".equals(value)) {
            return null;
        }
        TreeSet<RecurrenceId> recurrenceIds = new TreeSet<RecurrenceId>();
        for (String s : Strings.splitByComma(value)) {
            recurrenceIds.add(new DefaultRecurrenceId(s));
        }
        return recurrenceIds;
    }

    private static long parseDate(String value) throws Exception {
        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        dateFormat.setTimeZone(TimeZones.UTC);
        return dateFormat.parse(value).getTime();
    }

}
